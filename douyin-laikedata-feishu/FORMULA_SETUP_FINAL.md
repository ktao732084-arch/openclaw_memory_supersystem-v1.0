# 飞书公式字段配置指南（最终版）

## 配置完成时间
2026-02-14 15:57

## 数据源
使用 **Sheet2** 作为客资数据源（2951条原始客资记录）

---

## 三个公式字段

### 1. 客资数量

**字段名称**：`客资数量`  
**字段类型**：公式

**公式内容**：
```
[Sheet2].FILTER(
  AND(
    LEFT(CurrentValue.[单元ID], 15) = LEFT([单元ID], 15),
    LEFT(CurrentValue.[线索创建时间], 10) = [时间]
  )
).[手机号].COUNTA()
```

**说明**：
- 从 Sheet2 中筛选满足条件的客资记录
- 条件1：单元ID前15位匹配（避免科学计数法精度丢失）
- 条件2：日期匹配（线索创建时间的前10位 = 投放数据的时间字段）
- 统计筛选后的手机号数量

---

### 2. 实际获客成本

**字段名称**：`实际获客成本`  
**字段类型**：公式

**公式内容**：
```
IF([客资数量] > 0, [消耗(元)] / [客资数量], 0)
```

**说明**：
- 如果客资数量大于0，计算：消耗金额 ÷ 客资数量
- 如果客资数量为0，返回0（避免除以0错误）

---

### 3. 客资转化率(%)

**字段名称**：`客资转化率(%)`  
**字段类型**：公式

**公式内容**：
```
IF([客资数量] > 0, ([转化数] / [客资数量]) * 100, 0)
```

**说明**：
- 如果客资数量大于0，计算：(转化数 ÷ 客资数量) × 100
- 如果客资数量为0，返回0

---

## 配置步骤

### 步骤1：确保 Sheet2 字段类型正确

打开 Sheet2，检查字段类型：
- **单元ID**：必须是**文本类型**（不能是单选或数字）
- **手机号**：文本类型
- **线索创建时间**：文本类型（格式：2026-02-12 14:30:25）

如果单元ID是单选类型，需要：
1. 新建一个文本类型的字段
2. 复制单元ID的值到新字段
3. 删除旧的单元ID字段
4. 重命名新字段为"单元ID"

### 步骤2：在投放数据表中添加公式字段

1. 打开飞书多维表格 → 投放数据表
2. 点击右侧"+"添加字段
3. 字段名称：`客资数量`
4. 字段类型：选择"公式"
5. 复制粘贴公式1
6. 点击"确定"

重复步骤2-6，添加"实际获客成本"和"客资转化率(%)"字段。

### 步骤3：验证结果

检查投放数据表中的记录：
- 客资数量应该是个位数（0-9）或十位数
- 实际获客成本应该是合理的金额
- 客资转化率应该是百分比

---

## 关键技术点

### 1. CurrentValue 引用
在 FILTER 内部引用被筛选表的字段时，必须使用 `CurrentValue.[字段名]`：
```
[Sheet2].FILTER(CurrentValue.[单元ID] = ...)
```

### 2. LEFT() 函数
取字符串前N位：
```
LEFT([单元ID], 15)  // 取前15位
LEFT([线索创建时间], 10)  // 取前10位（日期部分）
```

### 3. AND() 函数
组合多个条件：
```
AND(条件1, 条件2)
```

### 4. COUNTA() 函数
统计非空值数量：
```
[Sheet2].[手机号].COUNTA()
```

### 5. IF() 函数
条件判断：
```
IF(条件, 为真时的值, 为假时的值)
```

---

## 数据匹配情况

### 投放数据表
- 日期范围：2026-02-01 到 2026-02-13
- 总记录数：439条

### Sheet2 客资数据
- 日期范围：2026-01-15 到 2026-02-12
- 总记录数：2951条
- 单元ID数量：48个不同的单元ID

### 匹配情况
- 匹配记录：18条（2月份有客资的投放记录）
- 匹配率：约 4%
- 说明：大部分投放单元没有客资，这是正常的

---

## 测试验证

### 测试1：基础引用
```
[Sheet2].[手机号].COUNTA()
```
预期结果：500+（Sheet2 总记录数）

### 测试2：LEFT 函数
```
LEFT([单元ID], 15)
```
预期结果：显示当前行单元ID的前15位

### 测试3：单元ID匹配
```
[Sheet2].FILTER(
  LEFT(CurrentValue.[单元ID], 15) = LEFT([单元ID], 15)
).[手机号].COUNTA()
```
预期结果：显示三位数（该单元ID所有日期的客资总数）

### 测试4：完整公式
```
[Sheet2].FILTER(
  AND(
    LEFT(CurrentValue.[单元ID], 15) = LEFT([单元ID], 15),
    LEFT(CurrentValue.[线索创建时间], 10) = [时间]
  )
).[手机号].COUNTA()
```
预期结果：显示个位数（该单元ID当天的客资数量）

---

## 常见问题

### Q1：客资数量显示0
**原因**：
1. Sheet2 中没有该单元ID的客资数据
2. 日期不匹配
3. 单元ID字段类型不是文本

**解决**：
- 检查 Sheet2 中是否有对应的客资数据
- 确认单元ID字段是文本类型

### Q2：客资数量显示三位数
**原因**：公式没有匹配日期，把所有日期的客资都加起来了

**解决**：检查公式中是否包含日期匹配条件：
```
LEFT(CurrentValue.[线索创建时间], 10) = [时间]
```

### Q3：公式报错
**原因**：
1. 字段名称不对
2. 语法错误
3. 字段类型不匹配

**解决**：
- 检查字段名称是否完全一致（包括空格）
- 检查是否使用了 `CurrentValue`
- 确认 Sheet2 的单元ID是文本类型

---

## 维护说明

### Sheet2 数据更新
- **频率**：需要手动更新（或创建自动同步脚本）
- **方式**：从巨量引擎下载最新客资数据，导入到 Sheet2
- **注意**：确保单元ID字段保持文本类型

### 公式字段
- **自动计算**：飞书会自动计算，无需手动触发
- **更新延迟**：可能有几秒钟的延迟
- **修改公式**：点击字段设置 → 编辑公式

---

## 完成标志

✅ 客资数量能正确显示（个位数或十位数）  
✅ 实际获客成本能正确计算  
✅ 客资转化率能正确计算  
✅ 所有公式字段在投放数据表中正常工作

---

**配置完成时间**：2026-02-14 15:57  
**配置人员**：Tkao + Ktao  
**状态**：✅ 已完成并验证
