# 飞书多维表格完整自动化方案

## 需求分析

### 需求1：自动统计客资数据
- 检测到新投放数据 → 自动匹配客资 → 计算统计指标

### 需求2：自动分类到账户模块
- 检测到新投放数据 → 根据账户名称和日期 → 自动归类到对应视图

---

## 完整方案设计

### 表格结构

**表1：投放数据表（主表）**
- 账户名称（文本）
- 日期（日期）
- 单元ID（文本）
- 单元名称（文本）
- 消耗(元)（数字）
- 转化数（数字）
- 转化成本(元)（公式）
- 团购线索数（数字）
- **客资数量（公式）** ← 自动统计
- **实际获客成本（公式）** ← 自动计算
- **客资转化率(%)（公式）** ← 自动计算

**表2：客资数据表**
- 手机号（文本）
- 单元ID前15位（文本）
- 日期（日期）
- 客户姓名（文本）

---

## 功能1：自动统计客资数据

### 实现方式：公式字段

#### 配置步骤

1. **在投放数据表中添加公式字段**

**客资数量**：
```
COUNTIFS(
  客资数据.单元ID前15位, 
  LEFT(单元ID, 15),
  客资数据.日期, 
  日期
)
```

**实际获客成本**：
```
IF(客资数量 > 0, 消耗(元) / 客资数量, 0)
```

**客资转化率(%)**：
```
IF(客资数量 > 0, (转化数 / 客资数量) * 100, 0)
```

2. **工作原理**
- 新增投放数据 → 公式自动计算
- 更新客资数据 → 公式自动重新计算
- 完全自动，无需手动触发

---

## 功能2：自动分类到账户模块

### 实现方式：视图 + 分组 + 筛选

#### 方案A：为每个账户创建独立视图（推荐）

##### 配置步骤

1. **创建账户视图**

在投放数据表中，为每个账户创建一个视图：

**视图1：郑州天后医疗美容医院有限公司-XL**
- 筛选条件：`账户名称` = "郑州天后医疗美容医院有限公司-XL"
- 排序：`日期` 降序（最新的在最上面）
- 分组：`日期`（按天分组）

**视图2：DX-郑州天后医疗美容医院**
- 筛选条件：`账户名称` = "DX-郑州天后医疗美容医院"
- 排序：`日期` 降序
- 分组：`日期`

**视图3：菲象_郑州天后_10**
- 筛选条件：`账户名称` = "菲象_郑州天后_10"
- 排序：`日期` 降序
- 分组：`日期`

...（为每个账户创建一个视图）

2. **工作原理**
- 新增数据时，飞书自动检测`账户名称`字段
- 自动归类到对应的视图
- 按日期降序排列，最新数据在最上面
- 按日期分组，方便查看每天的数据

3. **优势**
- ✅ 完全自动，无需手动操作
- ✅ 实时更新，数据写入立即生效
- ✅ 清晰直观，每个账户独立查看
- ✅ 支持快速切换账户

##### 批量创建视图的方法

**方法1：手动创建（推荐，简单）**
1. 点击视图下拉菜单
2. 点击"创建视图"
3. 命名为账户名称
4. 添加筛选条件：`账户名称` = "xxx"
5. 设置排序：`日期` 降序
6. 设置分组：`日期`
7. 重复以上步骤，为每个账户创建视图

**方法2：使用飞书API批量创建（高级）**

```python
#!/usr/bin/env python3
"""
批量创建账户视图
"""
import requests

FEISHU_APP_ID = "cli_a90737e0f5b81cd3"
FEISHU_APP_SECRET = "YOUR_APP_SECRET_HERE"
FEISHU_APP_TOKEN = "FEiCbGEDHarzyUsPG8QcoLxwn7d"
FEISHU_TABLE_ID = "tbl1n1PC1aooYdKk"

# 账户列表
ACCOUNTS = [
    "郑州天后医疗美容医院有限公司-XL",
    "DX-郑州天后医疗美容医院",
    "本地推-ka-郑州天后医疗美容医院有限公司",
    "菲象_郑州天后_10",
    "菲象_郑州天后_27",
    "菲象_郑州天后_新",
    "郑州天后医疗美容-智慧本地推-1",
]

def get_feishu_token():
    """获取飞书访问令牌"""
    url = "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal"
    payload = {"app_id": FEISHU_APP_ID, "app_secret": FEISHU_APP_SECRET}
    resp = requests.post(url, json=payload)
    return resp.json()['tenant_access_token']

def create_view(account_name):
    """为账户创建视图"""
    token = get_feishu_token()
    
    url = f"https://open.feishu.cn/open-apis/bitable/v1/apps/{FEISHU_APP_TOKEN}/tables/{FEISHU_TABLE_ID}/views"
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
    
    payload = {
        "view_name": account_name,
        "view_type": "grid",  # 表格视图
        "property": {
            "filter_info": {
                "conjunction": "and",
                "conditions": [
                    {
                        "field_name": "文本",  # 账户名称字段
                        "operator": "is",
                        "value": [account_name]
                    }
                ]
            },
            "sort_info": [
                {
                    "field_name": "时间",  # 日期字段
                    "desc": True  # 降序
                }
            ],
            "group_info": [
                {
                    "field_name": "时间"  # 按日期分组
                }
            ]
        }
    }
    
    resp = requests.post(url, headers=headers, json=payload)
    result = resp.json()
    
    if result.get('code') == 0:
        print(f"✓ 创建视图成功: {account_name}")
    else:
        print(f"✗ 创建视图失败: {account_name} - {result}")

if __name__ == '__main__':
    for account in ACCOUNTS:
        create_view(account)
```

#### 方案B：使用单个视图 + 分组（更简单）

##### 配置步骤

1. **创建"按账户分组"视图**
   - 视图名称：按账户分组
   - 分组字段：`账户名称`
   - 二级分组：`日期`
   - 排序：`日期` 降序

2. **工作原理**
   - 新增数据自动归类到对应账户分组
   - 每个账户下按日期二级分组
   - 最新数据在最上面

3. **优势**
   - ✅ 只需一个视图
   - ✅ 所有账户一目了然
   - ✅ 支持折叠/展开分组

4. **劣势**
   - ❌ 数据多时页面较长
   - ❌ 不如独立视图清晰

---

## 功能3：自动排名（额外功能）

### 需求
- 按消耗、客资数量、获客成本等指标排名
- 自动更新排名

### 实现方式：视图 + 排序

#### 配置步骤

1. **创建"消耗排行"视图**
   - 筛选条件：`日期` = 今天
   - 排序：`消耗(元)` 降序
   - 显示前10条

2. **创建"获客成本排行"视图**
   - 筛选条件：`日期` = 今天
   - 排序：`实际获客成本` 升序
   - 显示前10条

3. **创建"客资数量排行"视图**
   - 筛选条件：`日期` = 今天
   - 排序：`客资数量` 降序
   - 显示前10条

---

## 完整配置清单

### 第一步：创建客资数据表（5分钟）

1. 点击左下角"+"创建新表格
2. 命名为"客资数据"
3. 创建字段：
   - 手机号（文本）
   - 单元ID前15位（文本）
   - 日期（日期）
   - 客户姓名（文本）

### 第二步：配置公式字段（10分钟）

在投放数据表中添加3个公式字段：

1. **客资数量**
```
COUNTIFS(客资数据.单元ID前15位, LEFT(单元ID, 15), 客资数据.日期, 日期)
```

2. **实际获客成本**
```
IF(客资数量 > 0, 消耗(元) / 客资数量, 0)
```

3. **客资转化率(%)**
```
IF(客资数量 > 0, (转化数 / 客资数量) * 100, 0)
```

### 第三步：创建账户视图（15分钟）

**方案A**：为每个账户创建独立视图（推荐）
- 手动创建7个视图（每个账户一个）
- 或使用脚本批量创建

**方案B**：创建单个分组视图
- 创建"按账户分组"视图
- 分组：账户名称 → 日期
- 排序：日期降序

### 第四步：创建排行视图（可选，10分钟）

1. 消耗排行
2. 获客成本排行
3. 客资数量排行

### 第五步：修改同步脚本（15分钟）

**简化投放数据写入**（移除客资统计逻辑）：
```python
record = {
    "fields": {
        "文本": account_name,
        "时间": date,
        "单元ID": unit_id,
        "单元名称": unit_name,
        "消耗(元)": str(cost),
        "转化数": str(convert),
        "转化成本(元)": str(cost_per_convert),
        "团购线索数": str(leads)
    }
}
```

**新增客资数据上传脚本**：
```python
# 见之前的 upload_kezi_data.py
```

---

## 工作流程

### 日常使用

1. **每天早上7:00**
   - 定时任务自动运行
   - 同步昨天的投放数据
   - 数据自动归类到对应账户视图
   - 公式字段自动计算客资统计

2. **定期上传客资数据**（每周或每月）
   - 运行 `python3 upload_kezi_data.py <Excel文件>`
   - 客资数据写入客资数据表
   - 投放数据表的统计字段自动更新

3. **查看数据**
   - 切换到对应账户视图
   - 查看最新数据（按日期降序）
   - 查看排行榜（消耗、获客成本等）

---

## 优势总结

### 自动化程度

✅ **完全自动**：
- 投放数据自动归类到账户视图
- 客资统计自动计算
- 排名自动更新
- 无需任何手动操作

### 实时性

✅ **实时更新**：
- 数据写入立即生效
- 公式字段实时计算
- 视图实时刷新

### 易用性

✅ **简单直观**：
- 每个账户独立视图
- 最新数据在最上面
- 支持快速切换查看

### 可扩展性

✅ **灵活扩展**：
- 新增账户自动创建视图
- 新增指标只需添加公式字段
- 支持自定义排行榜

---

## 下一步

需要我帮你：
1. ✅ 创建客资数据表
2. ✅ 配置公式字段
3. ✅ 创建账户视图（手动或脚本）
4. ✅ 修改同步脚本

选择哪个方案？
- **方案A**：每个账户独立视图（推荐，更清晰）
- **方案B**：单个分组视图（更简单）

我可以立即开始实施！
