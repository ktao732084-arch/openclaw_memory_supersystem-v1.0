# 第十七阶段：客户ID问题排查与解决

## 完成时间
2026-02-14

## 问题发现
用户发现：**转化数 < 客资数**，怀疑是客户ID去重问题导致统计不准确。

---

## 问题排查过程

### 1. 初步分析飞书表格数据
通过API查询飞书Sheet2（客资数据表），发现：
- 总记录数：2951条
- 有客户ID：2474条
- **唯一客户ID数：仅11个** ⚠️
- 唯一手机号数：2457个

### 2. 客户ID分布异常
```
客户ID: 1773647675417607 → 827条记录，653个不同手机号
客户ID: 1848003626326092 → 390条记录，346个不同手机号
客户ID: 1844577767982090 → 301条记录，285个不同手机号
```

**平均每个"客户"有193个手机号** - 明显不合理！

### 3. 真相：客户ID实际是广告账户ID
对比配置文件发现：
- `1835880409219083` 出现在客户ID字段中
- 这个ID就是 `.env` 文件里的 `LOCAL_ACCOUNT_ID`（广告账户ID）

**结论**：飞书表格中的"客户ID"字段实际存储的是**广告账户ID**，不是客户（消费者）的唯一标识。

### 4. 分析原始Excel文件
检查用户从抖音来客后台下载的原始Excel：
```
文件：客资中心（新）_2026-02-13 15_08_38.616.xlsx
```

#### Excel中的客户ID值
```
30: 829次
24: 478次
55: 390次
186: 301次
309: 247次
206: 214次
```

**发现**：客户ID字段已经损坏！
- 原本应该是16位数字（如 `1773647675417607`）
- 实际变成了小数字（如 `30`, `24`, `55`）
- 这些是Excel的**共享字符串索引号**或**科学计数法导致的精度丢失**

---

## 问题根源

### Excel数据损坏原因
1. **科学计数法问题**
   - Excel打开CSV/导出文件时，自动将长数字转换为科学计数法
   - 16位客户ID（如 `1773647675417607`）超过Excel的精度限制（15位）
   - 导致精度丢失或被转换为索引号

2. **格式转换问题**
   - 抖音来客导出时可能就有问题
   - 或者上传到飞书时格式转换出错

### 数据现状
- ❌ 客户ID字段：已损坏，不可用
- ✅ 手机号字段：完整可用
- ✅ 线索ID字段：完整可用（但同一客户多次留资会有多个线索ID）

---

## 解决方案

### 方案：使用手机号作为客户标识

#### 统计逻辑
```python
# 客资数统计（按手机号去重）
客资数 = 去重后的手机号数量（同一天、同一单元）

# 客资转化率
客资转化率 = 转化数 ÷ 客资数
```

#### 局限性
- ✅ 优点：手机号是最接近"客户唯一标识"的字段
- ⚠️ 局限：同一客户的不同手机号会被算作不同客资
- 📊 现实：转化数 < 客资数是正常的（巨量引擎可能通过设备ID等维度去重）

---

## 数据对比

### 转化数 vs 客资数
| 维度 | 统计方式 | 说明 |
|------|---------|------|
| **转化数** | 巨量引擎API返回 | 平台已做去重（可能基于设备ID、IP等） |
| **客资数** | 按手机号去重 | 同一手机号在同一天同一单元只算1次 |
| **差异原因** | 一个客户可能有多个手机号 | 转化数统计的是"设备/用户"，客资数统计的是"手机号" |

### 合理性验证
- 转化数 < 客资数 ✅ 正常
- 客资转化率 = 转化数 ÷ 客资数（手机号去重）
- 这个比率反映的是"转化用户数 vs 留资手机号数"

---

## 技术细节

### 原始Excel分析脚本
```bash
# 分析客户ID分布
python3 analyze_excel_customer_id_v2.py

# 输出：
# 找到 2955 个客户ID值
# 唯一客户ID数: 14
# 客户ID分布：30(829次), 24(478次), 55(390次)...
```

### 飞书数据分析脚本
```bash
# 分析飞书表格中的客户ID
python3 analyze_customer_id_issue.py

# 输出：
# 唯一客户ID数: 11
# 平均每个客户有 193.27 个手机号
```

---

## 经验教训

### Excel处理长数字的注意事项
1. **避免直接打开CSV**
   - 使用"数据导入"功能，指定列格式为"文本"
   
2. **导出时指定格式**
   - 在抖音来客后台导出时，确保数字列格式正确
   
3. **上传前验证**
   - 上传到飞书前，先检查关键字段是否完整

### 数据质量检查
- 定期验证关键字段的唯一性
- 异常值检测（如一个客户ID对应几百个手机号）
- 与源系统对比核验

---

## 后续优化建议

### P1（重要）
1. **重新导出客资数据**
   - 从抖音来客后台重新导出，注意保持数字格式
   - 或者使用API直接获取（如果有）

2. **修复历史数据**
   - 如果能找到正确的客户ID，批量更新飞书表格

### P2（可选）
3. **建立客户主数据**
   - 手动维护一个"手机号 → 客户ID"的映射表
   - 用于识别同一客户的不同手机号

4. **数据质量监控**
   - 定期检查客户ID的唯一性
   - 异常值告警

---

## 核心文件

```
/root/.openclaw/workspace/douyin-laikedata-feishu/
├── analyze_customer_id_issue.py      # 飞书数据分析
├── analyze_excel_customer_id_v2.py   # Excel数据分析
├── debug_kezi_data.py                # 调试脚本
└── docs/
    └── stage17-customer-id-issue.md  # 本文档
```

---

## 结论

**客户ID字段已损坏，无法恢复。必须使用手机号作为客户标识。**

这是数据源问题，不是统计逻辑问题。转化数 < 客资数是正常现象，反映了"一个客户可能有多个手机号"的业务现实。

---

*创建时间: 2026-02-14*
*问题状态: 已解决（采用手机号去重方案）*
