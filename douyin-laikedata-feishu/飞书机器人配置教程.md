# 飞书机器人配置教程

## 功能说明

飞书机器人用于发送同步任务的通知消息，包括：
- ❌ 同步失败通知
- ⚠️ 数据异常告警
- ✅ 同步成功通知（可选）

## 配置步骤

### 1. 创建飞书群聊

如果还没有专门的通知群，建议创建一个：
- 打开飞书
- 点击右上角 "+" 号
- 选择 "创建群聊"
- 命名为 "抖音来客数据同步通知"（或其他名称）

### 2. 添加自定义机器人

1. 进入群聊
2. 点击右上角 "..." 或群设置
3. 选择 "机器人" 或 "群机器人"
4. 点击 "添加机器人"
5. 选择 "自定义机器人"

### 3. 配置机器人

1. **机器人名称**: 输入 "数据同步助手"（或其他名称）
2. **机器人描述**: 输入 "抖音来客数据同步状态通知"
3. **安全设置**（可选）:
   - 签名校验：不需要
   - IP白名单：不需要
   - 关键词：可以设置 "同步"、"失败"、"成功" 等

### 4. 获取 Webhook URL

1. 创建完成后，会显示 Webhook 地址
2. 格式类似：`https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
3. **复制这个地址**

### 5. 配置到项目

编辑 `.env` 文件，添加：

```bash
FEISHU_WEBHOOK_URL=https://open.feishu.cn/open-apis/bot/v2/hook/你的webhook地址
```

## 测试通知

运行测试脚本：

```bash
cd /root/.openclaw/workspace/douyin-laikedata-feishu
python3 notifier.py
```

如果配置正确，你会在飞书群里收到 4 条测试消息：
1. 同步失败通知
2. Token 刷新失败通知
3. 数据异常告警
4. 同步成功通知

## 消息示例

### 同步失败通知
```
❌ 数据同步失败

• 日期: 2026-02-12
• 错误: API 请求超时
• 重试 3 次后仍然失败
• 建议检查网络连接

时间: 2026-02-12 10:30:15
```

### 同步成功通知
```
✅ 数据同步成功

• 日期: 2026-02-12
• 记录数: 4 条
• 总消耗: 1,234.56 元
• 总转化: 12 个
• 平均转化成本: 102.88 元

时间: 2026-02-12 07:05:23
```

## 通知策略

### 默认策略（推荐）
- ❌ 失败时：立即通知
- ✅ 成功时：不通知（避免打扰）

### 如果想要成功通知
修改 `sync_data.py`，在 `sync_to_feishu()` 函数中，将成功通知的代码取消注释。

## 常见问题

### Q1: 收不到通知？
**检查清单**:
1. Webhook URL 是否正确配置
2. 机器人是否在群里
3. 运行 `python3 notifier.py` 测试
4. 查看控制台是否有错误信息

### Q2: 通知太频繁？
**解决方案**:
1. 关闭成功通知（默认已关闭）
2. 只保留失败通知
3. 设置通知频率限制（需要修改代码）

### Q3: 想要发送到多个群？
**解决方案**:
1. 在多个群里创建机器人
2. 获取多个 Webhook URL
3. 修改 `notifier.py`，支持多个 URL

### Q4: 想要更详细的通知？
**解决方案**:
修改 `notifier.py` 中的通知内容，添加更多字段。

## 安全建议

1. **不要公开 Webhook URL**
   - 任何人拿到 URL 都可以发消息到你的群
   - 不要提交到 Git 仓库
   - 已添加到 `.gitignore`

2. **设置关键词验证**（可选）
   - 在机器人设置中添加关键词
   - 只有包含关键词的消息才能发送
   - 例如：设置关键词 "同步"

3. **定期更换 Webhook**（可选）
   - 如果怀疑泄露，可以删除旧机器人
   - 重新创建并更新配置

## 高级功能

### 1. 自定义消息样式
修改 `notifier.py` 中的 `send_feishu_message()` 方法，可以自定义：
- 消息颜色
- 图标
- 字段布局
- 按钮（需要飞书开放平台权限）

### 2. 添加 @ 提醒
在消息中添加 `<at user_id="xxx">@某人</at>` 可以 @ 群成员。

### 3. 发送图片/文件
飞书机器人支持发送图片、文件等，需要修改消息格式。

## 参考文档

- [飞书自定义机器人指南](https://open.feishu.cn/document/ukTMukTMukTM/ucTM5YjL3ETO24yNxkjN)
- [飞书消息卡片搭建工具](https://open.feishu.cn/tool/cardbuilder)

---

**配置完成后，记得运行测试脚本验证！**
