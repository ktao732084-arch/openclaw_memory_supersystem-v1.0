# Token è‡ªåŠ¨åˆ·æ–°é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜å‘ç°

**æ—¶é—´**: 2026-02-16 ä¸Šåˆ

**ç°è±¡**: 
- å®šæ—¶ä»»åŠ¡æ—¥å¿—æ˜¾ç¤º"æˆåŠŸ"ï¼Œä½†å®é™…æ•°æ®åŒæ­¥å¤±è´¥
- é”™è¯¯ä»£ç  40102ï¼šaccess_token å·²è¿‡æœŸ
- 0 ä¸ªè´¦æˆ·æˆåŠŸï¼Œ0 æ¡è®°å½•åŒæ­¥

## æ ¹æœ¬åŸå› 

é¡¹ç›®ä¸­å­˜åœ¨**ä¸¤ä¸ªä¸åŒçš„åŒæ­¥è„šæœ¬**ï¼š

1. **`sync_data.py`** 
   - âœ… ä½¿ç”¨ `token_manager.get_valid_token()` 
   - âœ… æœ‰è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

2. **`sync_stable.py`** (å®šæ—¶ä»»åŠ¡ä½¿ç”¨)
   - âŒ ç›´æ¥ä» `.token_cache.json` è¯»å–å›ºå®š token
   - âŒ **æ²¡æœ‰è‡ªåŠ¨åˆ·æ–°æœºåˆ¶**

å®šæ—¶ä»»åŠ¡è°ƒç”¨çš„æ˜¯ `sync_stable.py`ï¼Œæ‰€ä»¥è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½**æ ¹æœ¬æ²¡æœ‰ç”Ÿæ•ˆ**ï¼

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹ `sync_stable.py`

**ä¿®æ”¹å‰**:
```python
def load_access_token():
    """åŠ è½½ Access Token"""
    try:
        with open(TOKEN_CACHE_PATH, 'r') as f:
            token_data = json.load(f)
            return token_data['access_token']
    except Exception as e:
        log(f"âŒ æ— æ³•åŠ è½½ Token: {e}")
        sys.exit(1)
```

**ä¿®æ”¹å**:
```python
# å¯¼å…¥ token_manager çš„è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
from token_manager import get_valid_token

def load_access_token():
    """åŠ è½½ Access Tokenï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰"""
    try:
        log("ğŸ”‘ è·å– Access Tokenï¼ˆè‡ªåŠ¨æ£€æµ‹è¿‡æœŸå¹¶åˆ·æ–°ï¼‰...")
        token = get_valid_token()
        if not token:
            log("âŒ æ— æ³•è·å–æœ‰æ•ˆ Token")
            sys.exit(1)
        log("âœ… Token è·å–æˆåŠŸ")
        return token
    except Exception as e:
        log(f"âŒ æ— æ³•åŠ è½½ Token: {e}")
        sys.exit(1)
```

### 2. å¢å¼º `token_manager.py`

#### 2.1 æ”¹è¿› Token ä¿å­˜ï¼ˆåŸå­æ€§ + éªŒè¯ï¼‰

**ä¿®æ”¹å‰**:
```python
def save_token_cache(token_data):
    try:
        with open(TOKEN_FILE, 'w') as f:
            json.dump(token_data, f, indent=2)
        print(f"âœ“ Token å·²ç¼“å­˜")
    except Exception as e:
        print(f"âŒ ä¿å­˜å¤±è´¥: {e}")
```

**ä¿®æ”¹å**:
```python
def save_token_cache(token_data):
    try:
        # 1. ç¡®ä¿ç›®å½•å­˜åœ¨
        os.makedirs(os.path.dirname(TOKEN_FILE), exist_ok=True)
        
        # 2. å†™å…¥ä¸´æ—¶æ–‡ä»¶
        temp_file = TOKEN_FILE + '.tmp'
        with open(temp_file, 'w') as f:
            json.dump(token_data, f, indent=2)
        
        # 3. åŸå­æ€§é‡å‘½åï¼ˆé¿å…å¹¶å‘å†²çªï¼‰
        os.replace(temp_file, TOKEN_FILE)
        
        # 4. éªŒè¯ä¿å­˜
        with open(TOKEN_FILE, 'r') as f:
            saved_data = json.load(f)
            if saved_data.get('access_token') != token_data.get('access_token'):
                print(f"âš ï¸  è­¦å‘Š: Token ä¿å­˜éªŒè¯å¤±è´¥ï¼")
                return False
        
        print(f"âœ“ Token ä¿å­˜éªŒè¯æˆåŠŸ")
        return True
    except Exception as e:
        print(f"âŒ ä¿å­˜å¤±è´¥: {e}")
        traceback.print_exc()
        return False
```

#### 2.2 å¢å¼ºæ—¥å¿—è¾“å‡º

**ä¿®æ”¹å‰**:
```python
print(f"âš ï¸  Access Token å³å°†è¿‡æœŸï¼Œå¼€å§‹åˆ·æ–°...")
```

**ä¿®æ”¹å**:
```python
remaining = (expires_at - now).total_seconds() / 3600
print(f"âš ï¸  Access Token å³å°†è¿‡æœŸï¼ˆå‰©ä½™ {remaining:.1f} å°æ—¶ï¼‰ï¼Œå¼€å§‹åˆ·æ–°...")
```

### 3. åˆ›å»ºè‡ªåŠ¨åŒ–æµ‹è¯•

æ–°å¢ `test_token_auto_refresh.py`ï¼š
- æµ‹è¯•æ­£å¸¸è·å– Token
- æ¨¡æ‹Ÿ Token å³å°†è¿‡æœŸåœºæ™¯
- éªŒè¯è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- æ£€æŸ¥æ–° Token æœ‰æ•ˆæœŸ

## æµ‹è¯•ç»“æœ

```bash
$ python3 test_token_auto_refresh.py

============================================================
Token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶æµ‹è¯•
============================================================

1ï¸âƒ£ æµ‹è¯•æ­£å¸¸è·å– Token...
   âœ… æˆåŠŸ: 54c64cb0c894be01aaca...

2ï¸âƒ£ æ¨¡æ‹Ÿ Token å³å°†è¿‡æœŸï¼ˆ30åˆ†é’Ÿåï¼‰...
   âœ… å·²ä¿®æ”¹ç¼“å­˜ï¼Œè¿‡æœŸæ—¶é—´è®¾ä¸º30åˆ†é’Ÿå

3ï¸âƒ£ å†æ¬¡è·å– Tokenï¼ˆåº”è§¦å‘è‡ªåŠ¨åˆ·æ–°ï¼‰...
âš ï¸  Access Token å³å°†è¿‡æœŸï¼ˆå‰©ä½™ 0.5 å°æ—¶ï¼‰ï¼Œå¼€å§‹åˆ·æ–°...
ğŸ”„ æ­£åœ¨åˆ·æ–° Access Token...
âœ… Access Token åˆ·æ–°æˆåŠŸï¼
   âœ… æˆåŠŸåˆ·æ–°: 54c64cb0c894be01aaca...
   âœ… æ–° Token æœ‰æ•ˆæœŸ: 23.9 å°æ—¶

============================================================
æµ‹è¯•å®Œæˆ
============================================================
```

## éªŒè¯

```bash
$ python3 token_manager.py status

============================================================
å·¨é‡å¼•æ“ Token çŠ¶æ€æ£€æŸ¥
============================================================

ğŸ“Š Token ä¿¡æ¯:
   Access Token: 54c64cb0c894be01aaca...
   è¿‡æœŸæ—¶é—´: 2026-02-17T11:40:39.890250
   å‰©ä½™æ—¶é—´: 24.0 å°æ—¶
   âœ… çŠ¶æ€æ­£å¸¸

   Refresh Token: c7c6a451acd18bb674df...
   è¿‡æœŸæ—¶é—´: 2026-03-18T11:40:39.890250
   å‰©ä½™æ—¶é—´: 30.0 å¤©
   âœ… çŠ¶æ€æ­£å¸¸
```

## æ”¹è¿›ç‚¹æ€»ç»“

1. âœ… **ç»Ÿä¸€ Token è·å–** - æ‰€æœ‰è„šæœ¬ä½¿ç”¨ `token_manager.get_valid_token()`
2. âœ… **åŸå­æ€§ä¿å­˜** - ä¸´æ—¶æ–‡ä»¶ + åŸå­é‡å‘½åï¼Œé¿å…å¹¶å‘å†²çª
3. âœ… **ä¿å­˜éªŒè¯** - å†™å…¥åç«‹å³è¯»å–éªŒè¯ï¼Œç¡®ä¿æ•°æ®å®Œæ•´
4. âœ… **è¯¦ç»†æ—¥å¿—** - æ˜¾ç¤ºå‰©ä½™æ—¶é—´ã€åˆ·æ–°è¿‡ç¨‹ã€é”™è¯¯å †æ ˆ
5. âœ… **è‡ªåŠ¨åŒ–æµ‹è¯•** - å¯é‡å¤éªŒè¯è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

## é¢„é˜²æªæ–½

### ç›‘æ§å»ºè®®

1. **å®šæœŸæ£€æŸ¥ Token çŠ¶æ€**
   ```bash
   python3 token_manager.py status
   ```

2. **æŸ¥çœ‹å®šæ—¶ä»»åŠ¡æ‰§è¡Œå†å²**
   ```bash
   openclaw cron runs <job_id>
   ```

3. **é…ç½®é£ä¹¦é€šçŸ¥** - Token åˆ·æ–°å¤±è´¥æ—¶è‡ªåŠ¨é€šçŸ¥

### æœ€ä½³å®è·µ

1. **ç»Ÿä¸€å…¥å£** - æ‰€æœ‰éœ€è¦ Token çš„è„šæœ¬éƒ½é€šè¿‡ `get_valid_token()` è·å–
2. **æå‰åˆ·æ–°** - å‰©ä½™æ—¶é—´ < 1å°æ—¶æ—¶è‡ªåŠ¨åˆ·æ–°ï¼Œé¿å…ä¸´ç•Œç‚¹å¤±è´¥
3. **é”™è¯¯é€šçŸ¥** - åˆ·æ–°å¤±è´¥æ—¶å‘é€é£ä¹¦é€šçŸ¥ï¼ŒåŠæ—¶äººå·¥ä»‹å…¥
4. **å®šæœŸæµ‹è¯•** - æ¯å‘¨è¿è¡Œä¸€æ¬¡ `test_token_auto_refresh.py`

## åç»­ä¼˜åŒ–

1. **æ·»åŠ é‡è¯•æœºåˆ¶** - åˆ·æ–°å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯• 3 æ¬¡
2. **å¤‡ç”¨ Token** - ä¿å­˜ä¸Šä¸€ä¸ªæœ‰æ•ˆ Token ä½œä¸ºå¤‡ä»½
3. **ç›‘æ§å‘Šè­¦** - Token å‰©ä½™æ—¶é—´ < 3 å¤©æ—¶æå‰é€šçŸ¥
4. **æ—¥å¿—å½’æ¡£** - ä¿å­˜ Token åˆ·æ–°å†å²ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

---

**ä¿®å¤æ—¶é—´**: 2026-02-16 11:40 UTC  
**ä¿®å¤äººå‘˜**: Tkao  
**å½±å“èŒƒå›´**: å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒæ­¥åŠŸèƒ½  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡
