# QMD é›†æˆåŠŸèƒ½çš„æœ€ä½³ä½ç½®åˆ†æ

## å½“å‰ QMD ç›¸å…³ä»£ç ä½ç½®

```
memory.py ä¸­å·²æœ‰:
â”œâ”€â”€ qmd_available()        # L1510 - æ£€æŸ¥ QMD æ˜¯å¦å¯ç”¨
â”œâ”€â”€ qmd_search()           # L1520 - QMD æ£€ç´¢
â”œâ”€â”€ _parse_qmd_output()    # L1570 - è§£æè¾“å‡º
â”œâ”€â”€ extract_memory_id_from_snippet()  # L1615 - æå– ID
â”œâ”€â”€ export_for_qmd()       # L1624 - å¯¼å‡ºä¸º QMD æ ¼å¼
â””â”€â”€ router_search()        # L1648 - å·²é›†æˆ QMD æ£€ç´¢
```

## Crabby å»ºè®®çš„åŠŸèƒ½ â†’ æœ€ä½³ä½ç½®

### 1. .gitignore ä¿æŠ¤
**åŠŸèƒ½**: é˜²æ­¢ .qmd/ ç›®å½•è¢« git è¿½è¸ª
**æœ€ä½³ä½ç½®**: `cmd_init()` (L1813)
**ç†ç”±**: åˆå§‹åŒ–æ—¶åˆ›å»ºç›®å½•ç»“æ„ï¼Œé¡ºä¾¿åˆ›å»º .gitignore æ˜¯è‡ªç„¶çš„

```python
# åœ¨ cmd_init() åˆ›å»ºç›®å½•åæ·»åŠ 
gitignore_path = memory_dir / '.gitignore'
if not gitignore_path.exists():
    with open(gitignore_path, 'w') as f:
        f.write('.qmd/\n')
```

### 2. ç´¢å¼•å¥åº·æ ¡éªŒ (health.lock + meta.json)
**åŠŸèƒ½**: é˜²æ­¢è„æ•°æ®ï¼Œæ£€æµ‹å†™å…¥ä¸­æ–­
**æœ€ä½³ä½ç½®**: 
- å†™å…¥é”: `export_for_qmd()` (L1624) â€” å†™å…¥å‰åˆ›å»ºï¼Œå®Œæˆååˆ é™¤
- å¥åº·æ£€æŸ¥: `qmd_available()` (L1510) â€” å¢å¼ºæ£€æµ‹é€»è¾‘

**ç†ç”±**: 
- export_for_qmd æ˜¯å”¯ä¸€å†™å…¥ QMD ç´¢å¼•çš„åœ°æ–¹
- qmd_available æ˜¯æ‰€æœ‰ QMD æ“ä½œçš„å…¥å£æ£€æŸ¥

```python
# export_for_qmd() æ”¹é€ 
def export_for_qmd(memory_dir):
    qmd_dir = memory_dir / '.qmd'
    lock_file = qmd_dir / 'health.lock'
    meta_file = qmd_dir / 'meta.json'
    
    # å†™å…¥å‰åˆ›å»ºé”
    lock_file.touch()
    try:
        # ... åŸæœ‰å¯¼å‡ºé€»è¾‘ ...
        
        # å†™å…¥ meta.json
        meta = {
            "version": "1.0",
            "updated": now_iso(),
            "count": total_count
        }
        with open(meta_file, 'w') as f:
            json.dump(meta, f)
    finally:
        # å®Œæˆååˆ é™¤é”
        lock_file.unlink(missing_ok=True)

# qmd_available() å¢å¼º
def qmd_available():
    # åŸæœ‰æ£€æŸ¥...
    
    # æ–°å¢ï¼šæ£€æŸ¥ health.lock
    qmd_dir = get_memory_dir() / '.qmd'
    if (qmd_dir / 'health.lock').exists():
        return False  # ä¸Šæ¬¡å†™å…¥ä¸­æ–­ï¼Œé™é»˜ fallback
    
    return True
```

### 3. ç©ºé—²æ—¶é—´è§¦å‘ç´¢å¼•æ›´æ–°
**åŠŸèƒ½**: ç”¨æˆ· 10 åˆ†é’Ÿæ²¡è¯´è¯æ—¶åå°æ›´æ–°ç´¢å¼•
**æœ€ä½³ä½ç½®**: è¿™ä¸æ˜¯ memory.py çš„èŒè´£ï¼Œè€Œæ˜¯ **OpenClaw è°ƒåº¦å±‚**
**ç†ç”±**: 
- memory.py æ˜¯è¢«è°ƒç”¨çš„å·¥å…·ï¼Œä¸åº”è¯¥æœ‰"ç­‰å¾…"é€»è¾‘
- ç©ºé—²æ£€æµ‹åº”è¯¥ç”± OpenClaw heartbeat æˆ– cron è§¦å‘

**å®ç°æ–¹å¼**: åœ¨ SKILL.md æˆ– cron é…ç½®ä¸­è¯´æ˜
```yaml
# cron é…ç½®ç¤ºä¾‹
- name: "idle-qmd-update"
  trigger: "idle_10min"  # OpenClaw ç©ºé—²æ£€æµ‹
  command: "memory.py export-qmd"
```

### 4. Hot Store æœç´¢ä¼˜å…ˆçº§
**åŠŸèƒ½**: æœç´¢æ—¶å…ˆæŸ¥æœªç´¢å¼•çš„æ–°è®°å¿†
**æœ€ä½³ä½ç½®**: `router_search()` (L1648)
**ç†ç”±**: router_search æ˜¯æ£€ç´¢å…¥å£ï¼Œæœç´¢é¡ºåºåœ¨è¿™é‡Œæ§åˆ¶

**ä½†æ˜¯**: è¿™ä¸ªåŠŸèƒ½ä¾èµ– pending.jsonlï¼ˆç™½å¤©è½»é‡æ£€æŸ¥çš„ç»„ä»¶ï¼‰
å¦‚æœåªåš QMD é›†æˆï¼Œæš‚æ—¶ä¸éœ€è¦è¿™ä¸ªã€‚

**å½“å‰æœç´¢é¡ºåº** (å·²å®ç°):
1. QMD ç´¢å¼•
2. å…³é”®è¯ç´¢å¼•
3. å®ä½“ç´¢å¼•

**æœªæ¥æœç´¢é¡ºåº** (åŠ å…¥ pending å):
1. pending (Hot Store)
2. QMD ç´¢å¼•
3. å…³é”®è¯/å®ä½“ç´¢å¼•
4. LLM å…œåº•

### 5. ç´¢å¼•æ›´æ–°è§¦å‘æ—¶æœº
**åŠŸèƒ½**: consolidation å + é˜ˆå€¼ + ç©ºé—²
**æœ€ä½³ä½ç½®**: 
- consolidation å: `cmd_consolidate()` Phase 6 ä¹‹å (L2380)
- é˜ˆå€¼è§¦å‘: éœ€è¦æ–°å¢è®¡æ•°é€»è¾‘

```python
# cmd_consolidate() Phase 6 ä¹‹åæ·»åŠ 
# Phase 6.5: QMD ç´¢å¼•æ›´æ–°
if qmd_available():
    print("\nğŸ” Phase 6.5: QMD ç´¢å¼•æ›´æ–°")
    export_for_qmd(memory_dir)
    print("   âœ… å®Œæˆ")
```

---

## æ€»ç»“ï¼šæœ€å°æ”¹åŠ¨æ–¹æ¡ˆ

| åŠŸèƒ½ | ä½ç½® | æ”¹åŠ¨é‡ |
|------|------|--------|
| .gitignore | cmd_init() | +5 è¡Œ |
| health.lock | export_for_qmd() | +10 è¡Œ |
| meta.json | export_for_qmd() | +8 è¡Œ |
| å¥åº·æ£€æŸ¥ | qmd_available() | +5 è¡Œ |
| consolidation åæ›´æ–° | cmd_consolidate() Phase 6 å | +5 è¡Œ |
| ç©ºé—²è§¦å‘ | SKILL.md / cron | é…ç½®ï¼Œä¸æ”¹ä»£ç  |
| Hot Store | ç­‰ pending å®ç°å | æš‚ä¸åš |

**æ€»è®¡**: ~33 è¡Œä»£ç æ”¹åŠ¨
