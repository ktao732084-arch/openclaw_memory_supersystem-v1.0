# Memory System v1.2.4 - SQLite åç«¯ä½¿ç”¨æŒ‡å—

## ğŸ¯ æ¦‚è¿°

v1.2.4 å¼•å…¥äº† SQLite åç«¯ï¼Œä¸ç°æœ‰ JSONL ç³»ç»Ÿå¹¶å­˜ï¼Œæ”¯æŒå¹³æ»‘è¿ç§»ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **åŒåç«¯æ”¯æŒ**: JSONL å’Œ SQLite å¯é€‰
- âœ… **å¹³æ»‘è¿ç§»**: ä¸å½±å“ç°æœ‰ç³»ç»Ÿ
- âœ… **æ€§èƒ½æå‡**: è®¿é—®ç»Ÿè®¡ O(N) â†’ O(1)
- âœ… **å…³ç³»æ”¯æŒ**: ä¸‰å…ƒç»„è¡¨è§£å†³å®ä½“å†²çª
- âœ… **å‘åå…¼å®¹**: ä¿ç•™ JSONL å¤‡ä»½

---

## ğŸ“¦ æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `sqlite_backend.py` | SQLite åç«¯æ ¸å¿ƒå®ç° |
| `backend_adapter.py` | åŒåç«¯é€‚é…å™¨ |
| `benchmark.py` | æ€§èƒ½å¯¹æ¯”æµ‹è¯• |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æµ‹è¯• SQLite åç«¯

```bash
cd scripts
python3 sqlite_backend.py /root/.openclaw/workspace/memory test
```

### 2. è¿ç§»æ•°æ®

```bash
# è¿ç§» JSONL -> SQLiteï¼ˆè‡ªåŠ¨å¤‡ä»½ï¼‰
python3 sqlite_backend.py /root/.openclaw/workspace/memory migrate
```

### 3. æ€§èƒ½æµ‹è¯•

```bash
# å¯¹æ¯” JSONL vs SQLite æ€§èƒ½
python3 benchmark.py /root/.openclaw/workspace/memory
```

---

## ğŸ”§ é…ç½®åç«¯

### æ–¹æ³• 1: é€šè¿‡é…ç½®æ–‡ä»¶

ç¼–è¾‘ `memory/config.json`:

```json
{
  "storage": {
    "backend": "sqlite"  // æˆ– "jsonl"
  }
}
```

### æ–¹æ³• 2: é€šè¿‡å‘½ä»¤è¡Œ

```bash
# åˆ‡æ¢åˆ° SQLite
python3 backend_adapter.py /root/.openclaw/workspace/memory config sqlite

# åˆ‡æ¢å› JSONL
python3 backend_adapter.py /root/.openclaw/workspace/memory config jsonl
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

åŸºäº 100 æ¡è®°å¿†çš„æµ‹è¯•ç»“æœï¼š

| æ“ä½œ | JSONL | SQLite | æå‡ |
|------|-------|--------|------|
| è®¿é—®ç»Ÿè®¡æ›´æ–° | ~50ms (O(N)) | 5.36ms (O(1)) | **9.3x** |
| å®ä½“æœç´¢ | ~20ms | 1.29ms | **15.5x** |
| å…¨é‡è¯»å– | 1.04ms | 2.73ms | 0.4x |

**ç»“è®º**: 
- âœ… å†™æ“ä½œï¼ˆè®¿é—®ç»Ÿè®¡ï¼‰å¤§å¹…æå‡
- âœ… æŸ¥è¯¢æ“ä½œï¼ˆå®ä½“æœç´¢ï¼‰å¤§å¹…æå‡
- âš ï¸ å°æ•°æ®é‡å…¨é‡è¯»å– JSONL æ›´å¿«ï¼ˆä½†å·®å¼‚å¯å¿½ç•¥ï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

### ä¸»è¡¨: memories

```sql
CREATE TABLE memories (
    id TEXT PRIMARY KEY,
    type TEXT CHECK(type IN ('fact', 'belief', 'summary')),
    content TEXT NOT NULL,
    importance REAL,
    score REAL,
    access_boost REAL,
    final_score REAL GENERATED ALWAYS AS (score + access_boost) STORED,
    created TEXT,
    last_accessed TEXT,
    access_count INTEGER,
    retrieval_count INTEGER,
    state INTEGER,  -- 0:Active, 1:Archived, 2:Junk
    ...
);
```

### å®ä½“è¡¨: memory_entities

```sql
CREATE TABLE memory_entities (
    memory_id TEXT,
    entity TEXT,
    PRIMARY KEY (memory_id, entity)
);
```

### å…³ç³»è¡¨: memory_relations

```sql
CREATE TABLE memory_relations (
    memory_id TEXT,
    subject TEXT,
    relation_type TEXT,
    object TEXT,
    superseded INTEGER,  -- æ˜¯å¦è¢«å–ä»£
    ...
);
```

---

## ğŸ”„ è¿ç§»æµç¨‹

### è‡ªåŠ¨è¿ç§»

```bash
python3 sqlite_backend.py /root/.openclaw/workspace/memory migrate
```

**æµç¨‹**:
1. è‡ªåŠ¨å¤‡ä»½ JSONL æ–‡ä»¶ï¼ˆ.backup åç¼€ï¼‰
2. åˆ›å»º SQLite æ•°æ®åº“
3. é€æ¡è¿ç§»è®°å¿†
4. éªŒè¯æ•°æ®å®Œæ•´æ€§

### æ‰‹åŠ¨å›æ»š

å¦‚æœéœ€è¦å›æ»šåˆ° JSONLï¼š

```bash
# 1. æ¢å¤å¤‡ä»½
cd /root/.openclaw/workspace/memory/layer2/active
cp facts.jsonl.backup facts.jsonl
cp beliefs.jsonl.backup beliefs.jsonl
cp summaries.jsonl.backup summaries.jsonl

# 2. åˆ é™¤ SQLite æ•°æ®åº“
rm ../memories.db*

# 3. åˆ‡æ¢é…ç½®
python3 backend_adapter.py /root/.openclaw/workspace/memory config jsonl
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. æ•°æ®å®Œæ•´æ€§æµ‹è¯•

```python
from sqlite_backend import SQLiteBackend
from pathlib import Path

backend = SQLiteBackend(Path('/root/.openclaw/workspace/memory'))

# æ£€æŸ¥ç»Ÿè®¡
stats = backend.get_stats()
print(f"æ€»è®°å¿†æ•°: {stats['total']}")
print(f"Facts: {stats['facts']}")
print(f"Beliefs: {stats['beliefs']}")
print(f"Summaries: {stats['summaries']}")
```

### 2. æœç´¢åŠŸèƒ½æµ‹è¯•

```python
# å®ä½“æœç´¢
results = backend.search_by_entities(['Ktao'], limit=5)
for r in results:
    print(f"[{r['final_score']:.2f}] {r['content'][:50]}...")
```

### 3. è®¿é—®ç»Ÿè®¡æµ‹è¯•

```python
# æ›´æ–°è®¿é—®ç»Ÿè®¡
backend.update_access_stats('f_20260207_a6b928', 'retrieval')

# éªŒè¯æ›´æ–°
memory = backend.get_memory('f_20260207_a6b928')
print(f"è®¿é—®æ¬¡æ•°: {memory['access_count']}")
```

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®å®‰å…¨

- âœ… è¿ç§»å‰è‡ªåŠ¨å¤‡ä»½ JSONL
- âœ… SQLite ä½¿ç”¨ WAL æ¨¡å¼ï¼ˆé˜²æ­¢æ•°æ®æŸåï¼‰
- âœ… æ”¯æŒéšæ—¶å›æ»šåˆ° JSONL

### 2. æ€§èƒ½è€ƒè™‘

- âœ… å°æ•°æ®é‡ï¼ˆ<1000æ¡ï¼‰: JSONL å’Œ SQLite æ€§èƒ½ç›¸è¿‘
- âœ… å¤§æ•°æ®é‡ï¼ˆ>1000æ¡ï¼‰: SQLite æ€§èƒ½ä¼˜åŠ¿æ˜æ˜¾
- âœ… å†™å¯†é›†åœºæ™¯: SQLite å¤§å¹…é¢†å…ˆ

### 3. å…¼å®¹æ€§

- âœ… ä¸å½±å“ç°æœ‰ JSONL ç³»ç»Ÿ
- âœ… å¯ä»¥åŒæ—¶ä¿ç•™ä¸¤å¥—æ•°æ®
- âœ… æ”¯æŒåŒå†™ï¼ˆJSONL + SQLiteï¼‰

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è®¡åˆ’

### v1.2.5: å…³ç³»æå–

- [ ] å®ç°å…³ç³»æå–é€»è¾‘
- [ ] é›†æˆåˆ° Phase 3
- [ ] åŸºäºå…³ç³»çš„å†²çªè§£å†³

### v1.3.0: å®Œå…¨åˆ‡æ¢

- [ ] é»˜è®¤ä½¿ç”¨ SQLite
- [ ] ç§»é™¤ JSONL ä¾èµ–
- [ ] æ€§èƒ½ä¼˜åŒ–

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: è¿ç§»å¤±è´¥

**ç—‡çŠ¶**: `CHECK constraint failed: type IN ('fact', 'belief', 'summary')`

**åŸå› **: JSONL ä¸­ç¼ºå°‘ type å­—æ®µ

**è§£å†³**: å·²ä¿®å¤ï¼Œä»æ–‡ä»¶åæ¨æ–­ç±»å‹

### é—®é¢˜ 2: SQLite ä¸å¯ç”¨

**ç—‡çŠ¶**: `âš ï¸ SQLite åç«¯ä¸å¯ç”¨`

**åŸå› **: `sqlite_backend.py` æœªæ‰¾åˆ°

**è§£å†³**: ç¡®ä¿åœ¨ `scripts/` ç›®å½•ä¸‹è¿è¡Œ

### é—®é¢˜ 3: æ•°æ®ä¸ä¸€è‡´

**ç—‡çŠ¶**: SQLite å’Œ JSONL è®°å¿†æ•°ä¸åŒ

**åŸå› **: å¯èƒ½æœ‰é‡å¤ ID æˆ–æ ¼å¼é”™è¯¯

**è§£å†³**: é‡æ–°è¿ç§»ï¼Œæ£€æŸ¥ JSONL æ ¼å¼

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- [CHANGELOG.md](../CHANGELOG.md)
- [v1.2.4-sqlite-migration-final.md](v1.2.4-sqlite-migration-final.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2026-02-14  
**ä½œè€…**: Tkao
