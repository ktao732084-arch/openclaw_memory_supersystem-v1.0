# v1.2 优化计划：四大肉瘤切除

## TL;DR
- **目标**: 切除 v1.1.7 的四个架构问题
- **优先级**: P0
- **四大问题**: ①双重复记(IO冗余) ②全量扫描(CPU浪费) ③静态快照(Token浪费) ④LLM滥用(钱浪费)
- **建议顺序**: 脏标记 → 规则强化 → 单一数据源 → 动态注入
- **当前进度**: 分析完成，待实现

---

> **来源**: 2026-02-11 [用户] 深度剖析
> **状态**: 待实现
> **优先级**: P0

---

## 1. 双重复记 (Double-Bookkeeping)

**痛点**: JSONL + Markdown + Python脚本，每次更新要操作三个地方

**优化方案**:
- 废弃单纯的 Markdown 存档
- Layer 2 回归单一数据源（单 JSONL）
- 人读版用即时生成的 `viewer.sh` 脚本，不作为持久化环节

**收益**: 消除数据冗余导致的 IO 阻塞

---

## 2. 全量扫描 (O(n) Calc Tax)

**痛点**: Phase 5 每次 Consolidation 都计算所有记录的衰减，大多数根本没变

**优化方案**:
- 引入"脏标记 (Dirty Bit)"
- 只有被引用/新加入的记录才进入计算
- 其他记录定"大结算周期"（一周一次）统一算

**收益**: 减少无效 CPU 计算

---

## 3. 静态快照 (The 2000-Token Tax)

**痛点**: Layer 1 固定 2000 tokens，不管对话内容是什么都塞进去

**优化方案**:
- 实现"基于关键词的动态注入"
- 用 Python 做极简 Inverted Index（倒排索引）
- 只有对话命中某些 Entity 时，相关 Fact 才注入
- 剩余 tokens 留给更相关的 Session 历史

**收益**: Context 利用率提升

---

## 4. LLM滥用 (Financial Redundancy)

**痛点**: Phase 2 让 LLM 判断"哈哈"是不是废话，大炮轰蚊子

**优化方案**:
- 极度强化"规则前置器"
- 扩充 CHAT_FILTER_PATTERNS 到 50+ 条
- 可选：引入简单的 Naive Bayes 分类器
- LLM 只处理规则判定为"模糊"的内容

**收益**: 减少 LLM 调用，省钱

---

## 实现顺序建议

| # | 优化项 | 复杂度 | 收益 | 优先级 |
|---|--------|--------|------|--------|
| 1 | 规则前置器强化 | ⭐ | 省钱 | P0 |
| 2 | 脏标记机制 | ⭐⭐ | 省CPU | P0 |
| 3 | 单一数据源 | ⭐⭐ | 简化架构 | P1 |
| 4 | 动态注入 | ⭐⭐⭐ | 提升相关性 | P1 |

---

## 与 QMD 集成的关系

这四项优化是**内部架构优化**，与 QMD 集成是**外部能力扩展**。

建议顺序：
1. 先做四大优化（清理内部债务）
2. 再做 QMD 集成（扩展检索能力）

---

*文档创建: 2026-02-12*

---

## 5. 白天轻量检查 (Mini-Consolidate)

> **状态**: 方案已确定，待实现
> **优先级**: P1
> **讨论日期**: 2026-02-12

### 痛点

Consolidation 每天只跑一次（凌晨3点），重要决策延迟到晚上才捕获。

### 最终方案：Pending Buffer + Mini-Consolidate

```
add → 重要性检测 → urgent 标记 → pending.jsonl
                              ↓
白天 mini-consolidate（每3小时）→ 优先处理 pending → 筛选 → 提取 → inject
```

**为什么不直接 inject？**
- 跳过筛选和去重，可能注入垃圾或重复内容
- Pending Buffer 保证质量，延迟可接受（最坏 3 小时）

### 实现清单

- [ ] `layer2/pending.jsonl` — 待审池
- [ ] `add` 命令改造 — 重要性检测，高分写入 pending
- [ ] `mini-consolidate` 命令 — 只处理 pending，跳过衰减
- [ ] cron 配置 — 白天 5 个时间点（UTC+8: 10, 13, 16, 19, 22）

### 待确认

1. 重要性阈值：importance > 0.8？还是关键词规则？
2. mini-consolidate 范围：只 pending？还是 pending + 最近 3h？
3. 时间点确认

### 收益

- 重要信息捕获延迟：24h → 3h
- 不牺牲质量（仍走筛选流程）
