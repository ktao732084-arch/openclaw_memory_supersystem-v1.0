# Memory System v1.1.5 发布说明

## 📦 发布信息
- **版本**: v1.1.5
- **发布日期**: 2026-02-06
- **核心改进**: 实体识别与隔离系统

---

## 🎯 本次更新目标

基于 Crabby 的深度代码审查，解决以下问题：

1. **实体识别靠硬编码** → 无法识别新实体
2. **相似实体混淆** → "机器人_50" 和 "机器人_5" 被同时返回
3. **访问加成被 days 稀释** → 老记忆新热点被埋没

---

## ✅ 核心改进

### 1. 🧠 三层实体识别

**问题**：v1.1.4 的实体识别依赖硬编码正则，无法识别新实体。

**解决方案**：三层识别架构

```
Layer 1: 硬编码模式（0 Token）
    ↓ 识别失败
Layer 2: 学习过的实体（0 Token）
    ↓ 识别失败  
Layer 3: LLM 提取 + 学习（有成本，但只调一次）
```

**效果**：
- ✅ 新实体自动学习，下次无需 LLM
- ✅ 模式归纳：3 个相似实体自动生成正则
- ✅ 类型保护：只归纳同类型后缀（数字/字母）

### 2. ⚡ 竞争性抑制（实体隔离）

**问题**：搜索 "机器人_50" 时，"机器人_5" 也被返回，导致信噪比崩溃。

**解决方案**：断崖式降权

```python
# 查询: "机器人_50"
f_001: "机器人_50 是个天才" → 精确匹配 → 权重 1.0
f_002: "机器人_5 是个笨蛋"  → 相似但不同 → 权重 × 0.1
f_003: "张三很聪明"         → 不相关 → 权重不变
```

**效果**：
- ✅ 精确匹配保持原权重
- ✅ 相似实体被抑制（× 0.1）
- ✅ 不相关实体不受影响
- ✅ 按需触发：只在存在相似实体时启用

### 3. 📈 访问加成修复（最近 N 天）

**问题**：v1.1.4 的公式 `boost = ln(count) * (count / days)` 中，days 是从创建开始算的，导致老记忆即使被频繁访问，加成也被稀释。

**旧公式**：
```
一年前的记忆，最近访问 10 次
boost = ln(11) * (10/365) * 0.2 = 0.013  ← 几乎没有加成
```

**新公式**：
```python
# 核心改进：根据最后访问时间计算有效访问次数
if days_since_access <= recent_days:  # 最近 7 天内访问过
    recency_factor = 1.0 - (days_since_access / recent_days) * 0.5
    effective_count = total_weighted * recency_factor
    if days_since_access <= 3:  # 3 天内额外加成
        effective_count *= 1.5
else:
    # 很久没访问，大幅降低
    decay = 0.9 ** (days_since_access - recent_days)
    effective_count = total_weighted * decay * 0.1
```

**效果**：
```
一年前的记忆，昨天访问 10 次
boost = 0.5  ← 满加成！老记忆被"复活"
```

### 4. 🗑️ 学习实体清理

**问题**：`learned_entities.json` 会无限增长。

**解决方案**：在 Phase 5 自动清理

```python
# 清理条件
- 精确实体：一年未使用 → 删除
- 模式：从未命中 → 删除
```

---

## 🧪 测试结果

```
============================================================
Memory System v1.1.5 - 实体识别与隔离系统测试
============================================================
  ✅ Layer 1 硬编码模式
  ✅ Layer 2 学习实体
  ✅ 模式归纳（类型保护）
  ✅ 实体相似度计算
  ✅ 实体隔离（竞争性抑制）
  ✅ 访问加成（最近 N 天）
  ✅ 学习实体清理
  ✅ 完整工作流

总计: 8/8 通过
🎉 所有测试通过！
```

---

## 📊 性能对比

| 场景 | v1.1.4 | v1.1.5 |
|------|--------|--------|
| 新实体识别 | ❌ 无法识别 | ✅ 自动学习 |
| 相似实体混淆 | ❌ 全部返回 | ✅ 精确隔离 |
| 老记忆复活 | ❌ 加成被稀释 | ✅ 满加成 |
| 学习实体膨胀 | ❌ 无限增长 | ✅ 自动清理 |

---

## 🔧 新增文件

| 文件 | 说明 |
|------|------|
| `v1_1_5_entity_system.py` | 实体识别与隔离核心模块 |
| `test_v1_1_5.py` | 测试用例 |
| `learned_entities.json` | 学习实体存储（自动生成） |

---

## 🚀 使用示例

### 实体识别
```python
from v1_1_5_entity_system import extract_entities

# 自动识别
entities, source = extract_entities("DeFi协议-A 很火", memory_dir)
# entities: ["DeFi协议-A"], source: "learned" 或 "llm"
```

### 实体隔离
```python
from v1_1_5_entity_system import apply_entity_isolation

# 搜索时自动应用
candidates = [...]  # 检索结果
filtered = apply_entity_isolation("机器人_50", candidates, memory_dir)
# 相似但不同的实体被降权
```

### 访问加成
```python
from v1_1_5_entity_system import calculate_access_boost_v1_1_5

# 计算加成（使用最近 7 天）
boost = calculate_access_boost_v1_1_5(memory)
# 最近访问的老记忆也能获得高加成
```

---

## 🙏 致谢

感谢 Crabby 的深度代码审查，发现了：
1. 实体识别的"路径依赖"问题
2. 访问加成的"历史稀释"问题
3. 相似实体的"信噪比崩溃"问题

这些问题的解决让 Memory System 更加健壮和智能。

---

**Memory System v1.1.5 - 实体识别与隔离，让记忆更精准** 🦞
