# 2026-02-05 - QMD 功能测试记录

## 测试概述

成功测试了 OpenClaw 最新版本的 QMD (Quick Memory Dump) 功能。QMD 是一个实验性的本地优先搜索引擎，结合了 BM25 + 向量搜索 + 重排序。

## 安装过程

### 1. 安装 Bun 运行时
```bash
curl -fsSL https://bun.sh/install | bash
```
- 安装成功，位置：`~/.bun/bin/bun`
- 版本：v1.3.8

### 2. 安装 QMD
```bash
export PATH="$HOME/.bun/bin:$PATH"
bun install -g github:tobi/qmd
```
- 安装时间：约 35 秒
- 安装了 260 个包
- 二进制文件：`qmd`
- 警告：sqlite-vec-win32-x64 404（正常，我们在 Linux 上）

## 功能测试

### 1. 创建集合并索引 ✅
```bash
cd /root/.openclaw/workspace
qmd collection add . --name workspace --mask "**/*.md"
```

**结果：**
- 成功索引 100 个 Markdown 文件
- 索引速度：非常快（几秒内完成）
- 索引大小：1.5 MB

### 2. BM25 全文搜索 ✅
```bash
qmd search "Moltbook" -c workspace --json
```

**结果：**
- 成功找到所有包含 "Moltbook" 的文档
- 返回内容：
  - 文档 ID
  - 相关性分数
  - 文件路径（qmd://workspace/...）
  - 文档标题
  - 代码片段（带上下文）
- JSON 输出格式清晰易读

**示例输出：**
```json
{
  "docid": "#89dce0",
  "score": 1,
  "file": "qmd://workspace/memory/moltbook/quick-reference.md",
  "title": "Moltbook记忆系统 - 快速参考",
  "snippet": "@@ -1,3 @@ (0 before, 131 after)\n# Moltbook记忆系统 - 快速参考\n\n## 🔄 自动更新机制"
}
```

### 3. 向量嵌入 ⏳
```bash
qmd embed
```

**状态：**
- 进程启动成功
- 正在下载嵌入模型（embeddinggemma-300M-Q8_0.gguf，约 600 MB）
- 遇到问题：
  - 第一次尝试：被系统 SIGKILL（可能内存不足）
  - 第二次尝试：timeout 300 秒后终止
  - 模型下载时间较长

**当前状态：**
- 文档已索引：100 个
- 向量已嵌入：0 个
- 待处理：100 个需要嵌入

## QMD 核心优势

1. **本地优先**
   - 完全在本地运行
   - 无需 API 密钥
   - 隐私保护

2. **混合搜索**
   - BM25（关键词匹配）
   - 向量搜索（语义理解）
   - 重排序（结果优化）

3. **快速索引**
   - 增量更新
   - 支持文件监控
   - 自动检测变化

4. **零配置**
   - 自动下载模型
   - 开箱即用
   - 简单命令行界面

5. **MCP 集成**
   - 可作为 MCP 服务器
   - 供 AI 代理使用

## 三种搜索方式

### 1. BM25 全文搜索（已可用）
```bash
qmd search "关键词" -c workspace
```
- 基于关键词匹配
- 不需要向量嵌入
- 速度快

### 2. 纯向量语义搜索（需要嵌入）
```bash
qmd vsearch "语义查询" -c workspace
```
- 基于语义相似度
- 需要向量嵌入完成
- 理解同义词和相关概念

### 3. 混合搜索（最强大，需要嵌入）
```bash
qmd query "查询内容" -c workspace
```
- 结合 BM25 + 向量 + 重排序
- 最佳搜索质量
- 需要向量嵌入完成

## 技术细节

### 索引配置
- **分块大小**：约 800 tokens
- **重叠比例**：15%
- **向量维度**：384 维
- **存储格式**：SQLite

### 模型信息
- **嵌入模型**：embeddinggemma-300M-Q8_0
- **模型大小**：约 600 MB
- **重排序模型**：qwen3-reranker-0.6b-q8_0
- **生成模型**：Qwen3-0.6B-Q8_0

### 系统要求
- **运行时**：Bun
- **SQLite**：需要支持扩展
- **内存**：建议 2GB+（用于模型加载）
- **存储**：约 1GB（模型 + 索引）

## 下一步计划

1. **完成向量嵌入**
   - 在内存充足时重新运行 `qmd embed`
   - 或考虑使用远程嵌入 API

2. **集成到 OpenClaw**
   - 配置 `memory.backend = "qmd"`
   - 设置自动更新间隔
   - 配置搜索参数

3. **性能优化**
   - 测试不同的搜索参数
   - 调整分块大小
   - 优化重排序权重

## 相关命令

```bash
# 查看状态
qmd status

# 列出集合
qmd collection list

# 更新索引
qmd update

# 清理缓存
qmd cleanup

# 获取文档
qmd get qmd://workspace/path/to/file.md

# 多文档获取
qmd multi-get "pattern" -l 100
```

## 结论

QMD 是一个非常强大的本地搜索工具，特别适合：
- 需要隐私保护的场景
- 离线工作环境
- 大量 Markdown 文档的管理
- AI 代理的记忆系统

BM25 全文搜索已经可以正常使用，向量搜索功能待模型下载完成后即可启用。

---

**测试时间**：2026-02-05 11:17-11:26 GMT+8  
**测试环境**：OpenClaw Gateway (Linux, 3.6GB RAM)  
**QMD 版本**：github:tobi/qmd#63028fd
