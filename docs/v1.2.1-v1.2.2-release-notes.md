# Memory System v1.2.1 & v1.2.2 å‘å¸ƒè¯´æ˜

## ç‰ˆæœ¬æ¦‚è§ˆ

| ç‰ˆæœ¬ | å‘å¸ƒæ—¥æœŸ | ä¸»é¢˜ |
|------|----------|------|
| v1.2.1 | 2026-02-12 | QMD é›†æˆå¢å¼º (Crabby å»ºè®®) |
| v1.2.2 | 2026-02-12 | ç™½å¤©è½»é‡æ£€æŸ¥ (Mini-Consolidate) |

---

## v1.2.1: QMD é›†æˆå¢å¼º

### èƒŒæ™¯
åŸºäº Crabby çš„å®æˆ˜ç»éªŒåé¦ˆï¼Œå¯¹ QMD å¯é€‰å¢å¼ºæ–¹æ¡ˆè¿›è¡Œè¡¥å……å®Œå–„ã€‚

### æ–°å¢åŠŸèƒ½

#### 1. ç´¢å¼•å¥åº·æ ¡éªŒ
- `health.lock`: å†™å…¥é”ï¼Œé˜²æ­¢è„æ•°æ®
- `meta.json`: å…ƒæ•°æ®ï¼ˆç‰ˆæœ¬ã€æ›´æ–°æ—¶é—´ã€è®°å¿†æ•°ï¼‰
- å†™å…¥å‰åˆ›å»ºé”ï¼Œå®Œæˆååˆ é™¤
- å¦‚æœ health.lock å­˜åœ¨ â†’ ä¸Šæ¬¡å†™å…¥ä¸­æ–­ â†’ é™é»˜ fallback åˆ° LLM

#### 2. .gitignore ä¿æŠ¤
```bash
# memory/.gitignore
.qmd/
```
é˜²æ­¢ç”¨æˆ· git ä»“åº“å› ç´¢å¼•æ–‡ä»¶çˆ†ç‚¸ã€‚

#### 3. qmd_available() å¢å¼º
- æ£€æŸ¥ qmd å‘½ä»¤æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥ qmd status æ˜¯å¦æ­£å¸¸
- æ£€æŸ¥ health.lock æ˜¯å¦å­˜åœ¨ï¼ˆå†™å…¥ä¸­æ–­æ ‡è®°ï¼‰

#### 4. Phase 6.5 è‡ªåŠ¨æ›´æ–°
- åœ¨ consolidation Phase 6 (ç´¢å¼•æ›´æ–°) ä¹‹å
- è‡ªåŠ¨è°ƒç”¨ export_for_qmd() æ›´æ–° QMD ç´¢å¼•
- å¤±è´¥æ—¶é™é»˜é™çº§ï¼Œä¸å½±å“ä¸»æµç¨‹

### ç›®å½•ç»“æ„å˜æ›´
```
memory/
â”œâ”€â”€ .gitignore          # æ–°å¢ï¼šä¿æŠ¤ .qmd/
â”œâ”€â”€ .qmd/               # æ–°å¢ï¼šQMD ç´¢å¼•ç›®å½•
â”‚   â”œâ”€â”€ index/
â”‚   â”‚   â”œâ”€â”€ facts.md
â”‚   â”‚   â”œâ”€â”€ beliefs.md
â”‚   â”‚   â””â”€â”€ summaries.md
â”‚   â”œâ”€â”€ meta.json       # æ–°å¢ï¼šå…ƒæ•°æ®
â”‚   â””â”€â”€ health.lock     # ä¸´æ—¶ï¼šå†™å…¥é”
â””â”€â”€ layer2/
    â””â”€â”€ qmd-index/      # ä¿ç•™ï¼šå…¼å®¹æ—§ç‰ˆ
```

### è®¾è®¡åŸåˆ™
- å…ˆä¿è¯æ´»ç€ï¼ˆLLM å…œåº•ï¼‰ï¼Œå†è¿½æ±‚è·‘å¾—å¿«ï¼ˆQMD åŠ é€Ÿï¼‰
- é™é»˜ fallbackï¼šQMD ä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§ï¼Œç”¨æˆ·æ— æ„Ÿ

---

## v1.2.2: ç™½å¤©è½»é‡æ£€æŸ¥ (Mini-Consolidate)

### èƒŒæ™¯
- å½“å‰ consolidation åªåœ¨å‡Œæ™¨ 3 ç‚¹è¿è¡Œï¼Œé‡è¦ä¿¡æ¯å»¶è¿Ÿæ•è·
- å‚è€ƒç«å“"ä¸‰å±‚Cronç³»ç»Ÿ"çš„ Hourly Micro-Sync æ€è·¯
- éœ€è¦å¹³è¡¡"å®æ—¶æ€§"å’Œ"è´¨é‡ä¿è¯"

### æ ¸å¿ƒè®¾è®¡

**è¢«å¦å†³çš„æ–¹æ¡ˆ**ï¼šæ£€æµ‹åˆ°é‡è¦ä¿¡æ¯ç›´æ¥ inject åˆ° Layer 1
- âŒ å¤ªé²è½ï¼Œè·³è¿‡ç­›é€‰å¯èƒ½æ³¨å…¥åƒåœ¾

**æœ€ç»ˆæ–¹æ¡ˆ**ï¼šPending Buffer + Mini-Consolidate
```
add â†’ é‡è¦æ€§æ£€æµ‹ â†’ urgent æ ‡è®° â†’ pending.jsonl
                              â†“
ç™½å¤© mini-consolidateï¼ˆæ¯3å°æ—¶ï¼‰â†’ ä¼˜å…ˆå¤„ç† pending â†’ ç­›é€‰ â†’ æå– â†’ inject
```

### æ–°å¢åŠŸèƒ½

#### 1. Urgent æ£€æµ‹è§„åˆ™
```python
URGENT_PATTERNS = {
    "critical": {  # èº«ä»½/å¥åº·/å®‰å…¨
        "keywords": ["è¿‡æ•", "ç–¾ç—…", "æ­»", "ç”Ÿå‘½", "ç´§æ€¥", "å±é™©", "æ€¥æ•‘",
                     "å¯†ç ", "è´¦å·", "é“¶è¡Œå¡", "èº«ä»½è¯"],
        "threshold": 0.9
    },
    "important": {  # é‡è¦äº‹ä»¶/å†³ç­–
        "keywords": ["è®°ä½", "æ°¸è¿œè®°ä½", "ä¸€å®šè¦è®°ä½", "é‡è¦", "å…³é”®",
                     "å†³å®š", "ç¡®å®š", "æœ€ç»ˆ"],
        "threshold": 0.8
    },
    "time_sensitive": {  # æ—¶é—´æ•æ„Ÿ
        "patterns": [
            r"(ä»Šå¤©|æ˜å¤©|åå¤©|ä¸‹å‘¨|ä¸‹ä¸ªæœˆ).*(å¿…é¡»|ä¸€å®š|æˆªæ­¢|deadline)",
            r"(å¿…é¡»|ä¸€å®š).*(ä»Šå¤©|æ˜å¤©|åå¤©|ä¸‹å‘¨)",
        ],
        "threshold": 0.8
    }
}
```

#### 2. Pending Buffer (Hot Store)
- æ–‡ä»¶: `layer2/pending.jsonl`
- å­˜æ”¾ urgent æ ‡è®°çš„è®°å¿†
- æœç´¢æ—¶ä¼˜å…ˆæŸ¥è¯¢ï¼ˆæ¯” QMD æ›´å¿«ï¼‰

#### 3. æ–°å¢å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `add-pending <content>` | æ·»åŠ å†…å®¹åˆ° pending buffer |
| `view-pending` | æŸ¥çœ‹ pending buffer |
| `mini-consolidate` | ç™½å¤©è½»é‡æ£€æŸ¥ |

#### 4. Mini-Consolidate æµç¨‹
```
1. è¯»å– pending.jsonl
2. Phase 2: ç­›é€‰ï¼ˆåºŸè¯æ£€æµ‹ + è§„åˆ™ç­›é€‰ï¼‰
3. Phase 3: æå–ï¼ˆå®ä½“æå– + æ„å»ºè®°å½•ï¼‰
4. å†™å…¥ layer2/active/
5. æ¸…ç©º pending.jsonl
6. æ›´æ–° QMD ç´¢å¼•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
```

#### 5. router_search() å¢å¼º
æœç´¢é¡ºåºï¼š
1. **Pending (Hot Store)** â€” æœªç´¢å¼•çš„æ–°è®°å¿†ï¼Œæå¿«
2. **QMD ç´¢å¼•** â€” å·²ç´¢å¼•ï¼Œå¿«é€Ÿè¯­ä¹‰æœç´¢
3. **å…³é”®è¯/å®ä½“ç´¢å¼•** â€” åŸæœ‰é€»è¾‘
4. **LLM å…œåº•** â€” QMD ä¸å¯ç”¨æ—¶

### ä½¿ç”¨ç¤ºä¾‹

```bash
# æ·»åŠ é‡è¦ä¿¡æ¯
$ memory.py add-pending "æˆ‘å¯¹èŠ±ç”Ÿè¿‡æ•ï¼Œåƒäº†ä¼šæ­»"
âœ… å·²æ·»åŠ åˆ° pending buffer
   ID: p_20260212_a455a4
   Urgent: True
   Importance: 0.9
   Category: critical

# æŸ¥çœ‹ pending
$ memory.py view-pending
ğŸ“‹ Pending Buffer (1 æ¡)
==================================================
ğŸ”´ [1] æˆ‘å¯¹èŠ±ç”Ÿè¿‡æ•ï¼Œåƒäº†ä¼šæ­»...
   importance=0.9 | 2026-02-12T04:46
==================================================
æ€»è®¡: 1 æ¡ | Urgent: 1 æ¡

# æ‰§è¡Œè½»é‡æ£€æŸ¥
$ memory.py mini-consolidate
ğŸ”„ Mini-Consolidate å¼€å§‹
   å¾…å¤„ç†: 1 æ¡
   å…¶ä¸­ urgent: 1 æ¡

ğŸ” Phase 2: ç­›é€‰
   âœ… ä¿ç•™ (urgent): æˆ‘å¯¹èŠ±ç”Ÿè¿‡æ•ï¼Œåƒäº†ä¼šæ­»...
   ç­›é€‰å: 1 æ¡

ğŸ“ Phase 3: æå–
   âœ… æå–: æˆ‘å¯¹èŠ±ç”Ÿè¿‡æ•ï¼Œåƒäº†ä¼šæ­»...

ğŸ’¾ å†™å…¥ active pool
   å†™å…¥ 1 æ¡è®°å½•
   æ¸…ç©º pending buffer

âœ… Mini-Consolidate å®Œæˆ
   å¤„ç†: 1 â†’ ä¿ç•™: 1
```

### è®¾è®¡åŸåˆ™
- ä¸ç›´æ¥ injectï¼Œä¿è¯è´¨é‡
- urgent è®°å¿†ä¼˜å…ˆå¤„ç†ï¼Œä½†ä»èµ°ç­›é€‰æµç¨‹
- æœ€åå»¶è¿Ÿ 3 å°æ—¶ï¼Œå¯æ¥å—

---

## ä»£ç æ”¹åŠ¨ç»Ÿè®¡

### v1.2.1
| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| memory.py | +50 è¡Œï¼ˆqmd_available, export_for_qmd, cmd_init, cmd_consolidateï¼‰ |

### v1.2.2
| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| memory.py | +330 è¡Œï¼ˆURGENT_PATTERNS, check_urgency, pending ç›¸å…³, mini-consolidate, router_searchï¼‰ |

---

## å¾…åŠäº‹é¡¹

1. **[P0] ç™½å¤© 5 æ—¶é—´ç‚¹ cron é…ç½®**
   - 10ç‚¹ã€13ç‚¹ã€16ç‚¹ã€19ç‚¹ã€22ç‚¹ (UTC+8)
   - è§¦å‘ mini-consolidate

2. **[P1] ç©ºé—²æ—¶é—´è§¦å‘ç´¢å¼•æ›´æ–°**
   - ç”¨æˆ· 10 åˆ†é’Ÿæ²¡è¯´è¯ â†’ åå°å¢é‡æ›´æ–°ç´¢å¼•

3. **[P2] è„æ ‡è®°æœºåˆ¶**
   - ç­‰è®°å¿†é‡å¢é•¿åå†åš

4. **[P3] é€šç”¨åŒ–æ”¹é€ **
   - è·¯å¾„å»ç¡¬ç¼–ç 
   - QMD å¯é€‰

---

## è‡´è°¢

- **Crabby**: v1.2.1 QMD å¢å¼ºå»ºè®®ï¼ˆhealth.lock, meta.json, .gitignore, ç©ºé—²è§¦å‘, Hot Storeï¼‰
- **Ktao**: ç™½å¤©è½»é‡æ£€æŸ¥æ–¹æ¡ˆè®¾è®¡ã€"ä¸ç›´æ¥ inject" çš„è´¨é‡ä¿è¯åŸåˆ™

---
*å‘å¸ƒæ—¥æœŸ: 2026-02-12*
*ä½œè€…: Tkao*
