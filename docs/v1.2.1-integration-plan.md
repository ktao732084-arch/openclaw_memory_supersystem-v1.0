# 新功能集成位置规划

## 当前架构理解

```
数据流:
Layer 3 (原始日志) → Consolidation (7 Phase) → Layer 2 (活跃池) → Layer 1 (工作记忆)
                                                      ↓
                                              router_search() 检索
```

## 新功能集成点

### 1. Pending Buffer (待审池)

**位置**: 在 `add` 命令和 Phase 1 之间
**文件**: `layer2/pending.jsonl`

```
add → 重要性检测 → urgent? → pending.jsonl
                         ↘ 普通 → layer3 日志
```

**代码位置**: 
- 新增 `check_urgency()` 函数
- 修改 `cmd_capture()` 或新增 `cmd_add()`

### 2. Mini-Consolidate

**位置**: 新命令，只处理 pending
**流程**: Phase 1-3 (收集→筛选→提取)，跳过 Phase 5 (衰减)

```python
def cmd_mini_consolidate(args):
    # 1. 读取 pending.jsonl
    # 2. Phase 2: 筛选
    # 3. Phase 3: 提取
    # 4. 写入 layer2/active/
    # 5. 清空 pending.jsonl
    # 6. 触发 inject 更新 Layer 1
```

### 3. Hot Store 搜索

**位置**: `router_search()` 最前面
**逻辑**: 先搜 pending，再搜 QMD，最后 LLM 兜底

```python
def router_search(query, ...):
    # 0. 先搜 pending (Hot Store) ← 新增
    pending_results = search_pending(query)
    
    # 1. QMD 检索 (已有)
    # 2. 关键词/实体检索 (已有)
    # 3. 合并去重 (pending 优先)
```

### 4. QMD 索引健康检查

**位置**: `qmd_available()` 函数增强
**文件**: `memory/.qmd/health.lock`, `memory/.qmd/meta.json`

```python
def qmd_available():
    # 检查 qmd 命令
    if not shutil.which("qmd"):
        return False
    # 检查 health.lock (写入中断标记)
    if (qmd_dir / "health.lock").exists():
        return False  # 静默 fallback
    return True
```

### 5. 索引更新触发

**位置**: 
- Phase 6 (索引) 之后 → 全量重建
- `cmd_add()` 中 → 阈值检测 (20条)
- heartbeat 中 → 空闲检测 (10分钟)

```python
# 在 cmd_consolidate() Phase 6 之后
if qmd_available():
    rebuild_qmd_index(memory_dir)

# 在 add 时检测
pending_count = count_pending()
if pending_count >= 20:
    trigger_incremental_qmd_update()
```

### 6. .gitignore 自动创建

**位置**: `cmd_init()` 中
**内容**: 
```
# memory/.gitignore
.qmd/
```

---

## 实现顺序建议

1. **pending.jsonl + check_urgency()** — 基础设施
2. **cmd_mini_consolidate()** — 核心功能
3. **router_search() 增加 pending 搜索** — Hot Store
4. **qmd_available() 健康检查** — 稳定性
5. **索引更新触发逻辑** — 自动化
6. **cron 配置** — 定时任务
